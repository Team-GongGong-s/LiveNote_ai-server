# RAG Text Upsert ë™ì‘ ê³¼ì • ìƒì„¸ ì„¤ëª…

## ğŸ“‹ ëª©ì°¨
1. [ì „ì²´ íë¦„ë„](#ì „ì²´-íë¦„ë„)
2. [ê° ë‹¨ê³„ë³„ ìƒì„¸ ì„¤ëª…](#ê°-ë‹¨ê³„ë³„-ìƒì„¸-ì„¤ëª…)
3. [í•„ë“œë³„ ì²˜ë¦¬ ë°©ì‹](#í•„ë“œë³„-ì²˜ë¦¬-ë°©ì‹)
4. [ì‹¤ì œ ì˜ˆì‹œ](#ì‹¤ì œ-ì˜ˆì‹œ)
5. [í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë°©ë²•](#í…ŒìŠ¤íŠ¸-ì‹¤í–‰-ë°©ë²•)

---

## ì „ì²´ íë¦„ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. HTTP ìš”ì²­                                                         â”‚
â”‚    POST /rag/text-upsert                                            â”‚
â”‚    Content-Type: application/json                                   â”‚
â”‚    Body: {"lecture_id": "cs101", "items": [...]}                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. FastAPI ì—”ë“œí¬ì¸íŠ¸ (server/routes/rag.py)                        â”‚
â”‚    - Pydantic ëª¨ë¸ ê²€ì¦ (TextUpsertRequest)                         â”‚
â”‚    - lecture_id ê²€ì¦ (ë¹„ì–´ìˆì§€ ì•Šì€ì§€)                               â”‚
â”‚    - items ê°œìˆ˜ ê²€ì¦ (ìµœì†Œ 1ê°œ ì´ìƒ)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Collection ID ìƒì„±                                               â”‚
â”‚    build_collection_id(prefix, lecture_id)                          â”‚
â”‚    ì˜ˆ: "lecture_" + "cs101" = "lecture_cs101"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Items ì „ì²˜ë¦¬ (routes/rag.py)                                     â”‚
â”‚    for each item:                                                   â”‚
â”‚      - metadata ë³µì‚¬ (ë¹ˆ dictë©´ {"source": "text"})                 â”‚
â”‚      - section_idê°€ ìˆìœ¼ë©´ â†’ metadata["section_id"] = section_id   â”‚
â”‚      - upsert_items ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. RAGService.upsert_text() í˜¸ì¶œ                                    â”‚
â”‚    asyncio.to_thread(_run)  # ë¸”ë¡œí‚¹ ì‘ì—…ì„ ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. UpsertItem ê°ì²´ ë³€í™˜ (ragkit/service.py)                         â”‚
â”‚    - dict â†’ UpsertItem ë³€í™˜                                         â”‚
â”‚    - UpsertItem(text, id?, section_id?, metadata)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Collection ìƒì„±/í™•ì¸                                              â”‚
â”‚    vector_store.create_collection(collection_id)                    â”‚
â”‚    - ì´ë¯¸ ì¡´ì¬í•˜ë©´ ìŠ¤í‚µ                                              â”‚
â”‚    - ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. ID ìƒì„± ë° ë°ì´í„° ì¤€ë¹„                                            â”‚
â”‚    for each item:                                                   â”‚
â”‚      - ID ì²˜ë¦¬:                                                     â”‚
â”‚        * item.idê°€ ìˆìœ¼ë©´ â†’ ê·¸ëŒ€ë¡œ ì‚¬ìš©                              â”‚
â”‚        * ì—†ìœ¼ë©´ â†’ make_id(item.text) (SHA256 í•´ì‹œ ê¸°ë°˜)             â”‚
â”‚      - metadata ë³‘í•©:                                               â”‚
â”‚        * item.metadata ë³µì‚¬                                         â”‚
â”‚        * item.section_idê°€ ìˆìœ¼ë©´ ì¶”ê°€                               â”‚
â”‚      - ids, texts, metadatas ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. ì„ë² ë”© ìƒì„± (OpenAI API)                                          â”‚
â”‚    embedding_service.embed_texts(texts)                             â”‚
â”‚    - ëª¨ë¸: text-embedding-3-large                                   â”‚
â”‚    - ì°¨ì›: 3072                                                     â”‚
â”‚    - ë°°ì¹˜ ì²˜ë¦¬: ìµœëŒ€ 2048ê°œê¹Œì§€ í•œ ë²ˆì—                              â”‚
â”‚    - ë¹„ìš©: ~$0.13 / 1M tokens                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. ChromaDB Upsert                                                 â”‚
â”‚     vector_store.upsert_many(                                       â”‚
â”‚         collection_id, ids, texts, embeddings, metadatas            â”‚
â”‚     )                                                               â”‚
â”‚     - ê°™ì€ ID ìˆìœ¼ë©´ â†’ ë®ì–´ì“°ê¸° (UPDATE)                             â”‚
â”‚     - ì—†ìœ¼ë©´ â†’ ìƒˆë¡œ ì‚½ì… (INSERT)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. ê²°ê³¼ ë°˜í™˜                                                        â”‚
â”‚     {                                                               â”‚
â”‚       "collection_id": "lecture_cs101",                             â”‚
â”‚       "result": {                                                   â”‚
â”‚         "collection_id": "lecture_cs101",                           â”‚
â”‚         "count": 5,                                                 â”‚
â”‚         "embedding_dim": 3072                                       â”‚
â”‚       }                                                             â”‚
â”‚     }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ê° ë‹¨ê³„ë³„ ìƒì„¸ ì„¤ëª…

### 1ë‹¨ê³„: HTTP ìš”ì²­

**ì…ë ¥ í˜•ì‹:**
```json
{
  "lecture_id": "cs101",
  "items": [
    {
      "text": "ë°ì´í„°ë² ì´ìŠ¤ëŠ”...",
      "id": "db_intro",              // ì„ íƒ
      "section_id": "1",             // ì„ íƒ
      "metadata": {                  // ì„ íƒ
        "subject": "CS",
        "difficulty": "ì¤‘ê¸‰"
      }
    }
  ]
}
```

**í•„ìˆ˜ í•„ë“œ:**
- `lecture_id`: ê°•ì˜ ì‹ë³„ì (ë¬¸ìì—´, ìµœì†Œ 1ì)
- `items`: ì—…ì„œíŠ¸í•  í•­ëª© ë°°ì—´ (ìµœì†Œ 1ê°œ)
- `items[].text`: ì €ì¥í•  í…ìŠ¤íŠ¸ (ë¬¸ìì—´, ìµœì†Œ 1ì)

**ì„ íƒ í•„ë“œ:**
- `items[].id`: ìˆ˜ë™ ID ì§€ì •
- `items[].section_id`: ì„¹ì…˜ ë²ˆí˜¸
- `items[].metadata`: ì„ì˜ì˜ JSON ë°ì´í„°

---

### 2ë‹¨ê³„: Pydantic ê²€ì¦

**ê²€ì¦ ê·œì¹™:**
```python
class TextUpsertItem(BaseModel):
    text: str = Field(..., min_length=1)          # í•„ìˆ˜, ìµœì†Œ 1ì
    id: Optional[str] = Field(default=None)       # ì„ íƒ
    section_id: Optional[str] = Field(default=None)  # ì„ íƒ
    metadata: dict[str, Any] = Field(default_factory=dict)  # ì„ íƒ

class TextUpsertRequest(BaseModel):
    lecture_id: str = Field(..., min_length=1)    # í•„ìˆ˜, ìµœì†Œ 1ì
    items: List[TextUpsertItem] = Field(..., min_length=1)  # í•„ìˆ˜, ìµœì†Œ 1ê°œ
```

**ê²€ì¦ ì‹¤íŒ¨ ì‹œ:**
- 400 Bad Request
- ì˜¤ë¥˜ ë©”ì‹œì§€ í¬í•¨

---

### 3ë‹¨ê³„: Collection ID ìƒì„±

**í•¨ìˆ˜:**
```python
def build_collection_id(prefix: str, lecture_id: str) -> str:
    return f"{prefix}{lecture_id}"
```

**ì˜ˆì‹œ:**
```python
# settings.rag.collection_prefix = "lecture_"
build_collection_id("lecture_", "cs101") â†’ "lecture_cs101"
build_collection_id("lecture_", "math201") â†’ "lecture_math201"
```

**ëª©ì :**
- ê°•ì˜ë³„ë¡œ ë…ë¦½ëœ ë²¡í„° DB ì»¬ë ‰ì…˜ ìƒì„±
- ê²€ìƒ‰ ì„±ëŠ¥ í–¥ìƒ (ê´€ë ¨ ì—†ëŠ” ê°•ì˜ ì œì™¸)

---

### 4ë‹¨ê³„: Items ì „ì²˜ë¦¬

**ì½”ë“œ:**
```python
upsert_items = []
for item in request.items:
    metadata = dict(item.metadata or {})  # 1. metadata ë³µì‚¬
    
    if item.section_id:                    # 2. section_id ì¶”ê°€
        metadata.setdefault("section_id", item.section_id)
    
    if not metadata:                       # 3. ë¹ˆ metadataë©´ ê¸°ë³¸ê°’
        metadata["source"] = "text"
    
    upsert_items.append({                  # 4. ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
        "text": item.text,
        "id": item.id,
        "metadata": metadata,
        "section_id": item.section_id,
    })
```

**ì²˜ë¦¬ ë¡œì§:**

| ì…ë ¥ | ì¶œë ¥ metadata |
|------|---------------|
| `{}` | `{"source": "text"}` |
| `{"subject": "CS"}` | `{"subject": "CS"}` (ê·¸ëŒ€ë¡œ) |
| `section_id="1"`, `metadata={}` | `{"section_id": "1", "source": "text"}` |
| `section_id="1"`, `metadata={"subject":"CS"}` | `{"subject": "CS", "section_id": "1"}` |

---

### 5-6ë‹¨ê³„: RAGService í˜¸ì¶œ

**ë¹„ë™ê¸° ì²˜ë¦¬:**
```python
def _run():
    return rag_service.upsert_text(
        collection_id=collection_id,
        items=upsert_items
    )

result = await asyncio.to_thread(_run)  # ë¸”ë¡œí‚¹ ì‘ì—…ì„ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰
```

**ì´ìœ :**
- `rag_service.upsert_text()`ëŠ” ë™ê¸° í•¨ìˆ˜ (ë¸”ë¡œí‚¹)
- OpenAI API, ChromaDB ëª¨ë‘ ë¸”ë¡œí‚¹ I/O
- `asyncio.to_thread()`ë¡œ ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰
- FastAPIì˜ ë¹„ë™ê¸° ë£¨í”„ ì°¨ë‹¨ ë°©ì§€

---

### 7ë‹¨ê³„: Collection ìƒì„±

**ì½”ë“œ:**
```python
self.vector_store.create_collection(collection_id)
```

**ë™ì‘:**
- ì»¬ë ‰ì…˜ì´ ì—†ìœ¼ë©´ â†’ ìƒˆë¡œ ìƒì„±
- ì´ë¯¸ ìˆìœ¼ë©´ â†’ ìŠ¤í‚µ (ì—ëŸ¬ ì—†ìŒ)

**ChromaDB ì €ì¥ ìœ„ì¹˜:**
- `server_storage/chroma_data/` ë˜ëŠ”
- `server_storage/chroma_data_real/`

---

### 8ë‹¨ê³„: ID ìƒì„± ë° ë°ì´í„° ì¤€ë¹„

**ID ìƒì„± ë¡œì§:**
```python
def make_id(text: str) -> str:
    """í…ìŠ¤íŠ¸ë¥¼ í•´ì‹œí•˜ì—¬ ê³ ìœ  ID ìƒì„±"""
    import hashlib
    hash_obj = hashlib.sha256(text.encode("utf-8"))
    return hash_obj.hexdigest()[:16]  # 16ìë¦¬ í•´ì‹œ
```

**ì˜ˆì‹œ:**
```python
make_id("ë°ì´í„°ë² ì´ìŠ¤ëŠ” êµ¬ì¡°í™”ëœ ë°ì´í„°ì˜ ì§‘í•©ì…ë‹ˆë‹¤.")
â†’ "a3f5c8d9e2b1f6a7"

make_id("SQLì€ Structured Query Languageì˜ ì•½ìì…ë‹ˆë‹¤.")
â†’ "b9e3f7c1d4a6e8f2"
```

**ID ì²˜ë¦¬ ë°©ì‹:**
| `item.id` | ê²°ê³¼ ID | ì„¤ëª… |
|-----------|---------|------|
| `None` | ìë™ ìƒì„± (í•´ì‹œ) | `make_id(item.text)` |
| `"custom_id"` | `"custom_id"` | ê·¸ëŒ€ë¡œ ì‚¬ìš© |

**Metadata ë³‘í•©:**
```python
metadata = dict(item.metadata)     # 1. ê¸°ë³¸ metadata ë³µì‚¬
if item.section_id:                # 2. section_id ì¶”ê°€
    metadata["section_id"] = item.section_id
```

---

### 9ë‹¨ê³„: ì„ë² ë”© ìƒì„±

**OpenAI API í˜¸ì¶œ:**
```python
embeddings = self.embedding_service.embed_texts(texts)
```

**ëª¨ë¸ ì •ë³´:**
- **ëª¨ë¸ëª…**: `text-embedding-3-large`
- **ì°¨ì›**: 3072 (ê³ ì°¨ì› â†’ ë†’ì€ ì •í™•ë„)
- **ì»¨í…ìŠ¤íŠ¸**: 8191 í† í°
- **ê°€ê²©**: ~$0.13 / 1M tokens

**ë°°ì¹˜ ì²˜ë¦¬:**
```python
# ìµœëŒ€ 2048ê°œê¹Œì§€ í•œ ë²ˆì— ì²˜ë¦¬
texts = ["text1", "text2", "text3", ...]
embeddings = client.embeddings.create(
    model="text-embedding-3-large",
    input=texts  # ë°°ì¹˜ ì „ì†¡
)
```

**ì„±ëŠ¥:**
- 10ê°œ í…ìŠ¤íŠ¸: ~1-2ì´ˆ
- 100ê°œ í…ìŠ¤íŠ¸: ~5-10ì´ˆ
- 1000ê°œ í…ìŠ¤íŠ¸: ë°°ì¹˜ ë¶„í•  (2048ê°œì”©)

**ê²°ê³¼ í˜•ì‹:**
```python
[
    [0.123, -0.456, 0.789, ...],  # 3072ì°¨ì› ë²¡í„°
    [0.234, -0.567, 0.890, ...],  # 3072ì°¨ì› ë²¡í„°
    ...
]
```

---

### 10ë‹¨ê³„: ChromaDB Upsert

**í˜¸ì¶œ:**
```python
count = self.vector_store.upsert_many(
    collection_id=collection_id,
    ids=ids,
    texts=texts,
    embeddings=embeddings,
    metadatas=metadatas,
)
```

**Upsert ë™ì‘:**
- **IDê°€ ì´ë¯¸ ì¡´ì¬** â†’ **UPDATE** (ë®ì–´ì“°ê¸°)
  * í…ìŠ¤íŠ¸ ê°±ì‹ 
  * ì„ë² ë”© ê°±ì‹ 
  * ë©”íƒ€ë°ì´í„° ê°±ì‹  (ì™„ì „ êµì²´)
  
- **IDê°€ ì—†ìŒ** â†’ **INSERT** (ìƒˆë¡œ ì¶”ê°€)
  * ìƒˆ ë¬¸ì„œ ì‚½ì…

**ì˜ˆì‹œ:**
```python
# ì²« ë²ˆì§¸ upsert
upsert_many(ids=["doc1"], texts=["ì›ë³¸ í…ìŠ¤íŠ¸"], ...)
â†’ INSERT: doc1 ìƒì„±

# ë‘ ë²ˆì§¸ upsert (ê°™ì€ ID)
upsert_many(ids=["doc1"], texts=["ìˆ˜ì •ëœ í…ìŠ¤íŠ¸"], ...)
â†’ UPDATE: doc1 ê°±ì‹ 
```

---

### 11ë‹¨ê³„: ê²°ê³¼ ë°˜í™˜

**ì‘ë‹µ í˜•ì‹:**
```json
{
  "collection_id": "lecture_cs101",
  "result": {
    "collection_id": "lecture_cs101",
    "count": 5,
    "embedding_dim": 3072
  }
}
```

**í•„ë“œ ì„¤ëª…:**
- `collection_id`: ìƒì„±ëœ ì»¬ë ‰ì…˜ ID
- `count`: ì—…ì„œíŠ¸ëœ í•­ëª© ìˆ˜
- `embedding_dim`: ì„ë² ë”© ì°¨ì› (3072)

---

## í•„ë“œë³„ ì²˜ë¦¬ ë°©ì‹

### 1. `text` (í•„ìˆ˜)

**ì—­í• :**
- ì €ì¥í•  ì‹¤ì œ í…ìŠ¤íŠ¸ ë‚´ìš©
- ì„ë² ë”© ìƒì„±ì˜ ì…ë ¥
- ê²€ìƒ‰ ì‹œ ë°˜í™˜ë˜ëŠ” í…ìŠ¤íŠ¸

**ì²˜ë¦¬:**
1. Pydantic ê²€ì¦ (ìµœì†Œ 1ì)
2. ì„ë² ë”© ìƒì„± (OpenAI API)
3. ChromaDBì— ì €ì¥

**ì œí•œ:**
- ìµœì†Œ: 1ì
- ìµœëŒ€: ì—†ìŒ (í•˜ì§€ë§Œ OpenAI í† í° ì œí•œ: 8191 í† í°)
- ê¶Œì¥: 100-500 ë‹¨ì–´

---

### 2. `id` (ì„ íƒ)

**ì—­í• :**
- ë¬¸ì„œì˜ ê³ ìœ  ì‹ë³„ì
- ì—…ë°ì´íŠ¸ ì‹œ ê¸°ì¤€

**ì²˜ë¦¬:**
- **ìˆìœ¼ë©´** â†’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
- **ì—†ìœ¼ë©´** â†’ `make_id(text)` ìë™ ìƒì„± (SHA256 í•´ì‹œ 16ìë¦¬)

**ê¶Œì¥ ì‚¬ìš©:**
```python
# âœ… ì¢‹ì€ ì˜ˆ: ì˜ë¯¸ ìˆëŠ” ID
{"id": "cs101_week1_intro", "text": "..."}

# âœ… ì¢‹ì€ ì˜ˆ: ì„¹ì…˜ë³„ ID
{"id": f"lecture_{lecture_id}_section_{section_id}", "text": "..."}

# âš ï¸ ì£¼ì˜: ìë™ ìƒì„±
{"text": "..."}  # ID = hash(text) = "a3f5c8d9e2b1f6a7"
```

**ì—…ë°ì´íŠ¸ ì‹œë‚˜ë¦¬ì˜¤:**
```python
# 1ì°¨: ì‚½ì…
upsert(id="doc1", text="ì›ë³¸")

# 2ì°¨: ì—…ë°ì´íŠ¸
upsert(id="doc1", text="ìˆ˜ì •ë³¸")  # â†’ doc1 ë®ì–´ì“°ê¸°
```

---

### 3. `section_id` (ì„ íƒ)

**ì—­í• :**
- ê°•ì˜ ë‚´ ì„¹ì…˜ êµ¬ë¶„
- ê²€ìƒ‰ ì‹œ í•„í„°ë§

**ì²˜ë¦¬:**
1. `metadata["section_id"]`ë¡œ ì €ì¥
2. ê²€ìƒ‰ ì‹œ í•„í„° ì¡°ê±´ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥

**í™œìš© ì˜ˆ:**
```python
# ì—…ì„œíŠ¸ ì‹œ
{
  "lecture_id": "cs101",
  "items": [
    {"text": "ì„¹ì…˜ 1 ë‚´ìš©", "section_id": "1"},
    {"text": "ì„¹ì…˜ 2 ë‚´ìš©", "section_id": "2"}
  ]
}

# ê²€ìƒ‰ ì‹œ (section_id="1"ë§Œ ê²€ìƒ‰)
/rag/query?collection_id=lecture_cs101&query=...&section_id=1
```

---

### 4. `metadata` (ì„ íƒ)

**ì—­í• :**
- ì„ì˜ì˜ JSON ë°ì´í„° ì €ì¥
- ê²€ìƒ‰ ì‹œ í•„í„°ë§, ì •ë ¬, ê·¸ë£¹í™”

**ì§€ì› íƒ€ì…:**
- ë¬¸ìì—´: `{"subject": "Computer Science"}`
- ìˆ«ì: `{"chapter": 3, "score": 9.5}`
- ë¶ˆë¦°: `{"is_important": true}`
- ë°°ì—´: `{"keywords": ["python", "programming"]}`
- ì¤‘ì²© ê°ì²´: `{"author": {"name": "ê¹€êµìˆ˜", "dept": "CS"}}`

**í™œìš© ì˜ˆ:**
```python
# í’ë¶€í•œ ë©”íƒ€ë°ì´í„°
{
  "text": "ì•Œê³ ë¦¬ì¦˜ì˜ ì‹œê°„ ë³µì¡ë„ëŠ”...",
  "metadata": {
    "subject": "ì•Œê³ ë¦¬ì¦˜",
    "category": "ì‹œê°„ë³µì¡ë„",
    "difficulty": "ì¤‘ê¸‰",
    "keywords": ["Big-O", "ë³µì¡ë„"],
    "professor": "ê¹€êµìˆ˜",
    "chapter": 3,
    "is_important": true,
    "created_at": "2025-01-14T10:30:00Z"
  }
}
```

**ê²€ìƒ‰ ì‹œ í™œìš©:**
```python
# difficulty="ì¤‘ê¸‰"ë§Œ ê²€ìƒ‰
collection.query(
    query_embeddings=[...],
    where={"difficulty": "ì¤‘ê¸‰"}
)

# chapter >= 3
collection.query(
    query_embeddings=[...],
    where={"chapter": {"$gte": 3}}
)
```

---

## ì‹¤ì œ ì˜ˆì‹œ

### ì˜ˆì‹œ 1: ìµœì†Œ í•„ë“œ (textë§Œ)

**ìš”ì²­:**
```json
{
  "lecture_id": "cs101",
  "items": [
    {
      "text": "ë°ì´í„°ë² ì´ìŠ¤ëŠ” êµ¬ì¡°í™”ëœ ë°ì´í„°ì˜ ì§‘í•©ì…ë‹ˆë‹¤."
    }
  ]
}
```

**ì²˜ë¦¬ ê³¼ì •:**
1. Collection ID: `"lecture_cs101"`
2. ID ìƒì„±: `make_id(text)` â†’ `"a3f5c8d9e2b1f6a7"`
3. Metadata: `{"source": "text"}`
4. ì„ë² ë”©: `[0.123, -0.456, ...]` (3072ì°¨ì›)
5. ChromaDB ì €ì¥

**ì €ì¥ëœ ë°ì´í„°:**
```python
{
  "id": "a3f5c8d9e2b1f6a7",
  "text": "ë°ì´í„°ë² ì´ìŠ¤ëŠ” êµ¬ì¡°í™”ëœ ë°ì´í„°ì˜ ì§‘í•©ì…ë‹ˆë‹¤.",
  "embedding": [0.123, -0.456, ...],
  "metadata": {"source": "text"}
}
```

---

### ì˜ˆì‹œ 2: ëª¨ë“  í•„ë“œ í¬í•¨

**ìš”ì²­:**
```json
{
  "lecture_id": "cs101",
  "items": [
    {
      "text": "ì•Œê³ ë¦¬ì¦˜ì˜ ì‹œê°„ ë³µì¡ë„ëŠ” Big-O í‘œê¸°ë²•ìœ¼ë¡œ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.",
      "id": "algo_complexity_intro",
      "section_id": "3",
      "metadata": {
        "subject": "ì•Œê³ ë¦¬ì¦˜",
        "category": "ì‹œê°„ë³µì¡ë„",
        "difficulty": "ì¤‘ê¸‰",
        "keywords": ["Big-O", "ë³µì¡ë„"],
        "chapter": 3
      }
    }
  ]
}
```

**ì²˜ë¦¬ ê³¼ì •:**
1. Collection ID: `"lecture_cs101"`
2. ID: `"algo_complexity_intro"` (ìˆ˜ë™ ì§€ì •)
3. Metadata ë³‘í•©:
   ```json
   {
     "subject": "ì•Œê³ ë¦¬ì¦˜",
     "category": "ì‹œê°„ë³µì¡ë„",
     "difficulty": "ì¤‘ê¸‰",
     "keywords": ["Big-O", "ë³µì¡ë„"],
     "chapter": 3,
     "section_id": "3"  â† section_id ì¶”ê°€
   }
   ```
4. ì„ë² ë”© ìƒì„±
5. ChromaDB ì €ì¥

**ì €ì¥ëœ ë°ì´í„°:**
```python
{
  "id": "algo_complexity_intro",
  "text": "ì•Œê³ ë¦¬ì¦˜ì˜ ì‹œê°„ ë³µì¡ë„ëŠ” Big-O í‘œê¸°ë²•ìœ¼ë¡œ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.",
  "embedding": [0.234, -0.567, ...],
  "metadata": {
    "subject": "ì•Œê³ ë¦¬ì¦˜",
    "category": "ì‹œê°„ë³µì¡ë„",
    "difficulty": "ì¤‘ê¸‰",
    "keywords": ["Big-O", "ë³µì¡ë„"],
    "chapter": 3,
    "section_id": "3"
  }
}
```

---

### ì˜ˆì‹œ 3: ì—…ë°ì´íŠ¸ (ê°™ì€ IDë¡œ ë®ì–´ì“°ê¸°)

**1ì°¨ ìš”ì²­:**
```json
{
  "lecture_id": "cs101",
  "items": [
    {
      "text": "íŒŒì´ì¬ì€ ì¸í„°í”„ë¦¬í„° ì–¸ì–´ì…ë‹ˆë‹¤.",
      "id": "python_intro",
      "metadata": {"version": 1}
    }
  ]
}
```

**ì €ì¥:**
```python
{
  "id": "python_intro",
  "text": "íŒŒì´ì¬ì€ ì¸í„°í”„ë¦¬í„° ì–¸ì–´ì…ë‹ˆë‹¤.",
  "metadata": {"version": 1, "source": "text"}
}
```

---

**2ì°¨ ìš”ì²­ (ì—…ë°ì´íŠ¸):**
```json
{
  "lecture_id": "cs101",
  "items": [
    {
      "text": "íŒŒì´ì¬ì€ ë™ì  íƒ€ì´í•‘ì„ ì§€ì›í•˜ëŠ” ê³ ìˆ˜ì¤€ ì¸í„°í”„ë¦¬í„° ì–¸ì–´ì…ë‹ˆë‹¤.",
      "id": "python_intro",
      "metadata": {"version": 2, "updated": true}
    }
  ]
}
```

**ì €ì¥ (ë®ì–´ì“°ê¸°):**
```python
{
  "id": "python_intro",
  "text": "íŒŒì´ì¬ì€ ë™ì  íƒ€ì´í•‘ì„ ì§€ì›í•˜ëŠ” ê³ ìˆ˜ì¤€ ì¸í„°í”„ë¦¬í„° ì–¸ì–´ì…ë‹ˆë‹¤.",
  "metadata": {"version": 2, "updated": true, "source": "text"}
}
```

**ì£¼ì˜:**
- ì´ì „ metadata (`{"version": 1}`)ëŠ” **ì™„ì „íˆ ì‚­ì œ**ë¨
- ìƒˆ metadataë¡œ **ì™„ì „ êµì²´**

---

## í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë°©ë²•

### 1. ì„œë²„ ì‹¤í–‰

```bash
cd /Users/hyunwookkim/Documents/study/25y2s/ìº¡ìŠ¤í†¤/LiveNote_í”„ë¡œí† íƒ€ì…/module_intergration
uvicorn server.main:app --reload
```

### 2. í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

```bash
./test_upsert.sh
```

### 3. ì¶œë ¥ í™•ì¸

**ì„±ê³µ ì‹œ:**
```json
{
  "collection_id": "lecture_cs101",
  "result": {
    "collection_id": "lecture_cs101",
    "count": 5,
    "embedding_dim": 3072
  }
}
```

**ì‹¤íŒ¨ ì‹œ:**
```json
{
  "detail": "lecture_idëŠ” ë¹„ì–´ ìˆì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
}
```

---

## ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ (FAQ)

### Q1: IDë¥¼ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?

**A:** í…ìŠ¤íŠ¸ë¥¼ SHA256 í•´ì‹œí•˜ì—¬ ìë™ ìƒì„±ë©ë‹ˆë‹¤.

```python
make_id("Hello World") â†’ "a591a6d40bf42..."
```

**ì£¼ì˜:** ê°™ì€ í…ìŠ¤íŠ¸ëŠ” í•­ìƒ ê°™ì€ IDë¥¼ ìƒì„±í•˜ë¯€ë¡œ, ê°™ì€ í…ìŠ¤íŠ¸ë¥¼ ë‘ ë²ˆ upsertí•˜ë©´ ë®ì–´ì“°ê¸°ë©ë‹ˆë‹¤.

---

### Q2: section_idì™€ metadataì˜ section_idê°€ ë‹¤ë¥´ë©´?

**A:** `section_id` í•„ë“œê°€ ìš°ì„ í•©ë‹ˆë‹¤.

```json
{
  "section_id": "1",
  "metadata": {"section_id": "2"}
}
```

**ê²°ê³¼:**
```json
{
  "metadata": {"section_id": "1"}  â† section_id í•„ë“œê°€ ìš°ì„ 
}
```

---

### Q3: ë¹ˆ metadataë©´?

**A:** ìë™ìœ¼ë¡œ `{"source": "text"}`ê°€ ì¶”ê°€ë©ë‹ˆë‹¤.

```json
{"text": "...", "metadata": {}}
â†’ {"metadata": {"source": "text"}}
```

---

### Q4: ëŒ€ëŸ‰ ë°ì´í„° ì—…ì„œíŠ¸ ì‹œ ì„±ëŠ¥ì€?

**A:**
- **10ê°œ**: ~1-2ì´ˆ
- **100ê°œ**: ~5-10ì´ˆ
- **1000ê°œ**: ~50-100ì´ˆ (ë°°ì¹˜ ë¶„í• )

**ê¶Œì¥:**
- í•œ ë²ˆì— 10-100ê°œ ì—…ì„œíŠ¸
- 1000ê°œ ì´ìƒì€ ë¶„í•  ì „ì†¡

---

### Q5: PDF Upsertì™€ì˜ ì°¨ì´ì ì€?

| íŠ¹ì§• | Text Upsert | PDF Upsert |
|------|-------------|------------|
| ì…ë ¥ | JSON (í…ìŠ¤íŠ¸) | PDF íŒŒì¼ (ë°”ì´ë„ˆë¦¬) |
| Content-Type | `application/json` | `multipart/form-data` |
| ID ìƒì„± | í•´ì‹œ or ìˆ˜ë™ | `{íŒŒì¼ëª…}\|p{í˜ì´ì§€ë²ˆí˜¸}` |
| Metadata | ììœ  í˜•ì‹ | `{"source": "íŒŒì¼ëª…", "page": N}` |
| ì²­í‚¹ | ì—†ìŒ (ì‚¬ìš©ìê°€ ì§ì ‘) | ìë™ (í˜ì´ì§€ ë‹¨ìœ„) |

---

## ìš”ì•½

### í•µì‹¬ íë¦„

```
ìš”ì²­ â†’ ê²€ì¦ â†’ Collection ID ìƒì„± â†’ ì „ì²˜ë¦¬ 
â†’ ID ìƒì„± â†’ ì„ë² ë”© ìƒì„± â†’ ChromaDB Upsert â†’ ì‘ë‹µ
```

### ì£¼ìš” íŠ¹ì§•

1. **ìë™ ID ìƒì„±**: ID ì—†ìœ¼ë©´ í•´ì‹œ ê¸°ë°˜ ìƒì„±
2. **Upsert ë™ì‘**: ê°™ì€ IDë©´ ë®ì–´ì“°ê¸°, ì—†ìœ¼ë©´ ì‚½ì…
3. **Metadata ë³‘í•©**: `section_id` â†’ `metadata["section_id"]`
4. **ë°°ì¹˜ ì„ë² ë”©**: ì—¬ëŸ¬ í…ìŠ¤íŠ¸ë¥¼ í•œ ë²ˆì— ì²˜ë¦¬
5. **ê°•ì˜ë³„ ê²©ë¦¬**: ê° `lecture_id`ë§ˆë‹¤ ë…ë¦½ëœ ì»¬ë ‰ì…˜

### ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

- **ì„ë² ë”© ìƒì„±**: OpenAI API í˜¸ì¶œ (ë¹„ìš© ë°œìƒ)
- **ë°°ì¹˜ ì²˜ë¦¬**: 10-100ê°œì”© ê¶Œì¥
- **ChromaDB**: ë¡œì»¬ ì €ì¥ (ë¹ ë¦„)
- **ë¹„ë™ê¸° ì²˜ë¦¬**: `asyncio.to_thread()` ì‚¬ìš©

---

## ë‹¤ìŒ ë‹¨ê³„

1. **ê²€ìƒ‰ í…ŒìŠ¤íŠ¸**: `/rag/query`ë¡œ ì €ì¥ëœ ë°ì´í„° ê²€ìƒ‰
2. **QA ìƒì„±**: `/qa/generate`ë¡œ ì§ˆë¬¸-ë‹µë³€ ìƒì„±
3. **ì¶”ì²œ ì‹œìŠ¤í…œ**: `/rec/recommend`ë¡œ ê´€ë ¨ ìë£Œ ì¶”ì²œ

---

**ì‘ì„±ì¼**: 2025-01-14
**ë²„ì „**: 1.0
